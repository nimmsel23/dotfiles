#!/usr/bin/env bash

# Claude Load Context - Dedicated Context Loader
# Usage: claude-load-context <mode>
# Modes: alphaos, fadaro, vitaldojo, claudewarrior, full

set -euo pipefail

# Colors
readonly CYAN='\033[0;36m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly MAGENTA='\033[0;35m'
readonly NC='\033[0m'

# Paths
readonly CONTEXT_DIR="${HOME}/.config/claudewarrior/contexts"
readonly LAST_CONTEXT_FILE="${HOME}/.config/claudewarrior/last-context"
readonly AGENTS_FILE="${HOME}/.agents/AGENTS.md"

# Ensure context dir exists
mkdir -p "${CONTEXT_DIR}"

# Mode selection
MODE="${1:-full}"

# Save last context
echo "${MODE}" > "${LAST_CONTEXT_FILE}"

# Helper functions
print_header() {
    local title="$1"
    local icon="$2"
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    printf "${CYAN}‚ïë${NC}  ${GREEN}${icon} %-56s${NC} ${CYAN}‚ïë${NC}\n" "${title}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

print_section() {
    echo -e "${BLUE}$1${NC}"
}

print_prompt() {
    local prompt_text="$1"
    echo ""
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${YELLOW}üìé Say to Claude Code:${NC}"
    echo ""
    echo -e "  \"${prompt_text}\""
    echo ""
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
}

# Context Loaders

load_alphaos() {
    print_header "ALPHAOS - ELLIOTT HULSE SYSTEM" "ü¶Å"

    print_section "üéØ Agent Active:"
    echo "  - alphaos-oracle (CRITICAL foundation agent)"
    echo ""

    print_section "üìö Focus Areas:"
    echo "  - Fire Maps (Daily/Weekly task burning)"
    echo "  - VOICE Sessions (STOP‚ÜíSUBMIT‚ÜíSTRUGGLE‚ÜíSTRIKE)"
    echo "  - War Stacks (Door + 4 Hits)"
    echo "  - General's Tent (Weekly review)"
    echo ""

    print_section "üóÇÔ∏è  Resources:"
    echo "  - Vault: ~/AlphaOs-Vault/"
    echo "  - 6 Pillar Files"
    echo "  - 42 Blueprints"
    echo ""

    print_section "üìä Current Tasks:"
    if command -v task >/dev/null 2>&1; then
        local fire_tasks=$(task +fire status:pending count 2>/dev/null || echo "0")
        local door_tasks=$(task +door status:pending count 2>/dev/null || echo "0")
        echo "  - Fire Map: ${fire_tasks} active"
        echo "  - Doors: ${door_tasks} open"
    fi

    print_prompt "Guide me through AlphaOS: Fire Maps, VOICE, or War Stacks"
}

load_fadaro() {
    print_header "FADARO - FITNESS CONTENT ENGINE" "üí™"

    print_section "ü§ñ Agents Active:"
    echo "  - fadaro-twitter-agent (Threads, hot takes, engagement)"
    echo "  - fadaro-blog-to-twitter (Blog ‚Üí Twitter conversion)"
    echo ""

    print_section "‚úçÔ∏è  Focus Areas:"
    echo "  - Blog posts (Von ATP zum Tao, Fitness Influenza, Raw Reflections)"
    echo "  - Twitter threads (5-10 tweets, curiosity gap)"
    echo "  - Hot takes (controversial singles)"
    echo "  - Content calendar strategy"
    echo ""

    print_section "üóÇÔ∏è  Resources:"
    echo "  - Project: ~/FADARO/"
    echo "  - Voice: Raw but Warm"
    echo "  - 4 Archetypen balance"
    echo ""

    print_section "üìä Current Tasks:"
    if command -v task >/dev/null 2>&1; then
        local fadaro_tasks=$(task project:FADARO status:pending count 2>/dev/null || echo "0")
        echo "  - FADARO tasks: ${fadaro_tasks} pending"
    fi

    print_prompt "Let's work on FADARO content: blog posts, Twitter threads, or strategy"
}

load_vitaldojo() {
    print_header "VITAL DOJO PROJECT" "ü•ã"

    print_section "üìã Project Status:"
    if [[ -d "${HOME}/vital-dojo" ]]; then
        echo "  - Location: ~/vital-dojo/"
        echo "  - Status: Active project"
    else
        echo "  - Location: Not found"
        echo "  - Note: Create ~/vital-dojo/ to activate"
    fi
    echo ""

    print_section "üóÇÔ∏è  Resources:"
    echo "  - Project directory: ~/vital-dojo/"
    echo ""

    print_section "üìä Current Tasks:"
    if command -v task >/dev/null 2>&1; then
        local vd_tasks=$(task project:VitalDojo status:pending count 2>/dev/null || echo "0")
        echo "  - Vital Dojo tasks: ${vd_tasks} pending"
    fi

    print_prompt "Let's work on Vital Dojo project"
}

load_claudewarrior() {
    print_header "CLAUDEWARRIOR - TASK ORCHESTRATION" "‚öîÔ∏è"

    print_section "ü§ñ Agent Active:"
    echo "  - claudewarrior (System agent)"
    echo ""

    print_section "‚öôÔ∏è  System Status:"
    echo "  - TodoWrite ‚Üí Taskwarrior migration: Active"
    echo "  - Smart migration rules:"
    echo "    ‚Ä¢ Threshold: 5+ todos"
    echo "    ‚Ä¢ Auto: #tw tag, FADARO.*, Project:*"
    echo ""

    print_section "üîó Integrations:"
    local gcal_enabled=$(jq -r '.google_calendar.enabled // false' "${HOME}/.config/claudewarrior/config.json" 2>/dev/null || echo "false")
    echo "  - Google Calendar: ${gcal_enabled}"
    echo "  - TickTick import: Available"
    echo "  - Obsidian export: Configured"
    echo ""

    print_section "üìä Current Tasks:"
    if command -v task >/dev/null 2>&1; then
        local cw_tasks=$(task +claudewarrior status:pending count 2>/dev/null || echo "0")
        local fire_today=$(task +fire due:today status:pending count 2>/dev/null || echo "0")
        echo "  - ClaudeWarrior tasks: ${cw_tasks}"
        echo "  - Fire Map today: ${fire_today}"
    fi
    echo ""

    print_section "üíª Commands:"
    echo "  - claudewarrior status"
    echo "  - claudewarrior sync"
    echo "  - task +claudewarrior"

    print_prompt "Let's manage tasks with ClaudeWarrior"
}

load_full() {
    # Fallback to original claude-context-generator
    if [[ -x "${HOME}/.dotfiles/bin/claude-context-generator" ]]; then
        exec "${HOME}/.dotfiles/bin/claude-context-generator" compact
    else
        echo "Error: claude-context-generator not found"
        exit 1
    fi
}

# Main dispatcher
main() {
    case "${MODE}" in
        alphaos|AlphaOS)
            load_alphaos
            ;;
        fadaro|Fadaro|FADARO)
            load_fadaro
            ;;
        vitaldojo|VitalDojo)
            load_vitaldojo
            ;;
        claudewarrior|ClaudeWarrior)
            load_claudewarrior
            ;;
        full|all)
            load_full
            ;;
        resume|last)
            # Load last context
            if [[ -f "${LAST_CONTEXT_FILE}" ]]; then
                last_mode=$(cat "${LAST_CONTEXT_FILE}")
                echo -e "${CYAN}‚ÑπÔ∏è  Resuming last context: ${last_mode}${NC}"
                echo ""
                exec "$0" "${last_mode}"
            else
                echo "No previous context found. Loading full context..."
                load_full
            fi
            ;;
        help|--help|-h)
            cat << 'EOF'
Claude Load Context - Dedicated Context Loader

USAGE:
    claude-load-context <mode>

MODES:
    alphaos         AlphaOS oracle + Fire Maps + VOICE
    fadaro          FADARO blog & Twitter agents
    vitaldojo       Vital Dojo project
    claudewarrior   Task orchestration system
    full            All contexts (default)
    resume          Load last used context

SHORTCUTS:
    Use Fish functions or Bash aliases:
    AlphaOS, Fadaro, VitalDojo, ClaudeWarrior, Resume

EXAMPLES:
    claude-load-context fadaro
    claude-load-context alphaos
    Resume  # (if alias configured)

EOF
            ;;
        *)
            echo "Error: Unknown mode '${MODE}'"
            echo "Run 'claude-load-context help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
