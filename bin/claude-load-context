#!/usr/bin/env bash

# Claude Load Context - Dedicated Context Loader v2
# Generates COMPLETE context blocks for copy-pasting into Claude Code

set -euo pipefail

# Colors
readonly CYAN='\033[0;36m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Paths
readonly LAST_CONTEXT_FILE="${HOME}/.config/claudewarrior/last-context"
readonly AGENTS_FILE="${HOME}/.agents/AGENTS.md"

# Ensure dirs exist
mkdir -p "$(dirname "${LAST_CONTEXT_FILE}")"

# Mode selection
MODE="${1:-full}"

# Save last context
echo "${MODE}" > "${LAST_CONTEXT_FILE}"

# Helper functions
print_header() {
    local title="$1"
    local icon="$2"
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    printf "${CYAN}‚ïë${NC}  ${GREEN}${icon} %-56s${NC} ${CYAN}‚ïë${NC}\n" "${title}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

print_context_block() {
    local context_name="$1"
    local context_text="$2"

    echo ""
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${YELLOW}üìé COPY THE TEXT BELOW TO CLAUDE CODE:${NC}"
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo "${context_text}"
    echo ""
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${CYAN}Context loaded: ${context_name}${NC}"
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
}

# Context Loaders

load_fadaro() {
    print_header "FADARO - FITNESS CONTENT ENGINE" "üí™"

    local fadaro_tasks=$(task project:FADARO status:pending count 2>/dev/null || echo "0")

    local context_text="I need you to load my FADARO context.

**FADARO is:**
A fitness content project focusing on blog posts and Twitter content creation.

**Active Agents:**
- fadaro-twitter-agent: Writes Twitter threads (5-10 tweets), hot takes, engagement strategy
- fadaro-blog-to-twitter: Converts blog posts to Twitter formats (threads + singles + quotes)

**Content Areas:**
- Blog Posts: \"Von ATP zum Tao\" (East-West fitness integration), \"Fitness Influenza\" (industry analysis), \"Raw Reflections\" (personal takes)
- Twitter Threads: 5-10 tweet threads with curiosity gap, 10% preview, 90% on blog
- Hot Takes: Controversial single tweets
- Voice: \"Raw but Warm\" - balance of 4 Archetypen

**Project Location:** ~/FADARO/

**Current Status:**
- Pending FADARO tasks in Taskwarrior: ${fadaro_tasks}

**What I want to work on:**
Let's create FADARO content - blog posts, Twitter threads, or strategy."

    print_context_block "FADARO" "${context_text}"
}

load_alphaos() {
    print_header "ALPHAOS - ELLIOTT HULSE SYSTEM" "ü¶Å"

    local fire_tasks=$(task +fire status:pending count 2>/dev/null || echo "0")
    local door_tasks=$(task +door status:pending count 2>/dev/null || echo "0")

    local context_text="I need you to load my AlphaOS context.

**AlphaOS is:**
A life operating system based on Elliott Hulse's philosophy (6 Pillars + 42 Blueprints).

**Active Agent:**
- alphaos-oracle: Foundation agent that guides Fire Maps, VOICE sessions, War Stacks, General's Tent reviews

**Core Systems:**
1. **Fire Maps** (Daily/Weekly task burning)
   - Daily Fire Map: Burn through 3-5 critical tasks
   - Weekly Fire Map: Review and plan the week

2. **VOICE Sessions** (STOP‚ÜíSUBMIT‚ÜíSTRUGGLE‚ÜíSTRIKE)
   - Process for transforming challenges into action

3. **War Stacks** (Door + 4 Hits)
   - Door: The big goal
   - 4 Hits: Actionable steps to achieve it

4. **Four Domains:**
   - BODY: Physical health, training, nutrition
   - BEING: Spirituality, meditation, inner work
   - BALANCE: Relationships, family, rest
   - BUSINESS: Work, projects, income

**Resources:**
- Vault: ~/AlphaOs-Vault/ (Obsidian)
- 6 Pillar Files (core philosophy)
- 42 Blueprints (detailed guides)

**Current Status:**
- Fire Map tasks: ${fire_tasks} active
- Open Doors: ${door_tasks}

**What I want to work on:**
Guide me through AlphaOS work - Fire Maps, VOICE session, or War Stack planning."

    print_context_block "AlphaOS" "${context_text}"
}

load_vitaldojo() {
    print_header "VITAL DOJO PROJECT" "ü•ã"

    local vd_tasks=$(task project:VitalDojo status:pending count 2>/dev/null || echo "0")

    local context_text="I need you to load my Vital Dojo context.

**Vital Dojo is:**
[Project description - to be filled in based on what Vital Dojo actually is]

**Project Location:** ~/vital-dojo/

**Current Status:**
- Pending Vital Dojo tasks: ${vd_tasks}

**What I want to work on:**
Let's work on the Vital Dojo project."

    print_context_block "Vital Dojo" "${context_text}"
}

load_claudewarrior() {
    print_header "CLAUDEWARRIOR - TASK ORCHESTRATION" "‚öîÔ∏è"

    local cw_tasks=$(task +claudewarrior status:pending count 2>/dev/null || echo "0")
    local fire_today=$(task +fire due:today status:pending count 2>/dev/null || echo "0")
    local gcal_enabled=$(jq -r '.google_calendar.enabled // false' "${HOME}/.config/claudewarrior/config.json" 2>/dev/null || echo "false")

    local context_text="I need you to load my ClaudeWarrior context.

**ClaudeWarrior is:**
An intelligent task orchestration system that manages tasks across TodoWrite, Taskwarrior, Google Calendar, TickTick, and Obsidian.

**Active Agent:**
- claudewarrior: System agent for smart task management

**How it works:**
1. **Smart TodoWrite Migration:**
   - Threshold: 5+ TodoWrite items ‚Üí suggest migration to Taskwarrior
   - Auto-migrate: #tw tag, FADARO.*, Project:* patterns
   - Prevents context loss across sessions

2. **Multi-Tool Sync:**
   - Taskwarrior ‚Üí Google Calendar (+fire tags, due dates)
   - TickTick ‚Üí Taskwarrior (via +claudewarrior tag)
   - Taskwarrior ‚Üí Obsidian (Fire Map exports)

3. **AlphaOS Integration:**
   - Respects UDAs: pillar, domain, alphatype, points
   - Fire Map system awareness
   - Four Domains tracking

**Current Status:**
- ClaudeWarrior tasks: ${cw_tasks}
- Fire Map tasks today: ${fire_today}
- Google Calendar sync: ${gcal_enabled}

**Commands:**
- \`claudewarrior status\` - Show sync status
- \`claudewarrior sync\` - Sync to Google Calendar
- \`task +claudewarrior\` - View ClaudeWarrior tasks

**What I want to work on:**
Let's manage my tasks using ClaudeWarrior - check status, sync calendars, or migrate todos."

    print_context_block "ClaudeWarrior" "${context_text}"
}

load_full() {
    # Fallback to original claude-context-generator
    if [[ -x "${HOME}/.dotfiles/bin/claude-context-generator" ]]; then
        exec "${HOME}/.dotfiles/bin/claude-context-generator" compact
    else
        echo "Error: claude-context-generator not found"
        exit 1
    fi
}

# Main dispatcher
main() {
    case "${MODE}" in
        alphaos|AlphaOS)
            load_alphaos
            ;;
        fadaro|Fadaro|FADARO)
            load_fadaro
            ;;
        vitaldojo|VitalDojo)
            load_vitaldojo
            ;;
        claudewarrior|ClaudeWarrior)
            load_claudewarrior
            ;;
        full|all)
            load_full
            ;;
        resume|last)
            if [[ -f "${LAST_CONTEXT_FILE}" ]]; then
                last_mode=$(cat "${LAST_CONTEXT_FILE}")
                echo -e "${CYAN}‚ÑπÔ∏è  Resuming last context: ${last_mode}${NC}"
                echo ""
                exec "$0" "${last_mode}"
            else
                echo "No previous context found. Loading full context..."
                load_full
            fi
            ;;
        help|--help|-h)
            cat << 'EOF'
Claude Load Context - Dedicated Context Loader v2

USAGE:
    claude-load-context <mode>

MODES:
    fadaro          FADARO blog & Twitter content
    alphaos         AlphaOS Fire Maps & VOICE
    vitaldojo       Vital Dojo project
    claudewarrior   Task orchestration
    full            All contexts
    resume          Load last used context

SHORTCUTS (Fish/Bash):
    Fadaro, AlphaOS, VitalDojo, ClaudeWarrior, Resume

WHAT'S NEW IN V2:
    - Full context blocks (not just prompts)
    - Detailed explanations of each system
    - Current task status included
    - Just copy-paste the whole block to Claude Code

EXAMPLES:
    claude-load-context fadaro
    Fadaro  # (if alias configured)
    Resume  # (load last context)

EOF
            ;;
        *)
            echo "Error: Unknown mode '${MODE}'"
            echo "Run 'claude-load-context help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
