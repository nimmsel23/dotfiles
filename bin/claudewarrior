#!/usr/bin/env bash

# ClaudeWarrior - Intelligent Task Orchestration System
# Version: 1.0.0
# Description: Hybrid CLI tool for managing tasks across Taskwarrior, TickTick, Google Calendar, and Obsidian

set -euo pipefail

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color

# Config paths
readonly CONFIG_DIR="${HOME}/.config/claudewarrior"
readonly CONFIG_FILE="${CONFIG_DIR}/config.json"
readonly LOG_DIR="${CONFIG_DIR}/logs"
readonly SESSION_FILE="${CONFIG_DIR}/session.state"
readonly SCRIPTS_DIR="${HOME}/.dotfiles/scripts/utils/integrations"

# Ensure config directory exists
mkdir -p "${CONFIG_DIR}" "${LOG_DIR}"

# Logging
log() {
    echo -e "${GREEN}[ClaudeWarrior]${NC} $1"
}

log_error() {
    echo -e "${RED}[ClaudeWarrior ERROR]${NC} $1" >&2
}

log_warn() {
    echo -e "${YELLOW}[ClaudeWarrior WARN]${NC} $1"
}

log_info() {
    echo -e "${CYAN}[ClaudeWarrior]${NC} $1"
}

# Check if config exists, create default if not
ensure_config() {
    if [[ ! -f "${CONFIG_FILE}" ]]; then
        log_warn "Config not found, creating default config..."
        cat > "${CONFIG_FILE}" << 'EOF'
{
  "version": "1.0.0",
  "thresholds": {
    "todowrite_max": 5,
    "auto_migrate_age_days": 2,
    "stale_task_warn_days": 7
  },
  "auto_migrate_patterns": [
    "FADARO.*",
    "Project:.*",
    ".*#tw.*"
  ],
  "google_calendar": {
    "fire_map_cal_id": "",
    "trainingsplan_cal_id": "",
    "default_cal_id": "",
    "enabled": false
  },
  "ticktick": {
    "import_tag": "+claudewarrior",
    "remove_tag_after_import": false,
    "enabled": false
  },
  "obsidian": {
    "vault_path": "~/AlphaOs-Vault",
    "daily_notes_template": "VOICE/templates/daily-claudewarrior.md",
    "export_interval_minutes": 30,
    "enabled": false
  },
  "calcure": {
    "enabled": false,
    "auto_sync": true
  }
}
EOF
        log "Created default config at ${CONFIG_FILE}"
        log_info "Edit this file to configure your integrations"
    fi
}

# Status command
cmd_status() {
    log "ClaudeWarrior Status Report"
    echo ""

    # Taskwarrior stats
    echo -e "${BLUE}ðŸ“‹ Taskwarrior:${NC}"
    local tw_total=$(task +claudewarrior status:pending count 2>/dev/null || echo "0")
    local tw_fire=$(task +fire status:pending count 2>/dev/null || echo "0")
    echo "  â”œâ”€ ClaudeWarrior tasks: ${tw_total}"
    echo "  â”œâ”€ Fire Map tasks: ${tw_fire}"

    local tw_today=$(task +OVERDUE status:pending count 2>/dev/null || echo "0")
    echo "  â””â”€ Overdue: ${tw_today}"

    echo ""

    # TickTick integration status
    echo -e "${BLUE}ðŸ“± TickTick:${NC}"
    if [[ -f "${HOME}/.config/ticktick/config.json" ]]; then
        echo "  â”œâ”€ Status: Configured âœ“"
        local tt_enabled=$(jq -r '.ticktick.enabled // false' "${CONFIG_FILE}" 2>/dev/null || echo "false")
        echo "  â””â”€ Integration: ${tt_enabled}"
    else
        echo "  â””â”€ Status: Not configured"
    fi

    echo ""

    # Google Calendar status
    echo -e "${BLUE}ðŸ“… Google Calendar:${NC}"
    local gcal_enabled=$(jq -r '.google_calendar.enabled // false' "${CONFIG_FILE}" 2>/dev/null || echo "false")
    echo "  â”œâ”€ Integration: ${gcal_enabled}"
    if [[ "${gcal_enabled}" == "true" ]]; then
        echo "  â”œâ”€ Fire Map Cal: $(jq -r '.google_calendar.fire_map_cal_id' "${CONFIG_FILE}" 2>/dev/null || echo "not set")"
        echo "  â””â”€ Training Cal: $(jq -r '.google_calendar.trainingsplan_cal_id' "${CONFIG_FILE}" 2>/dev/null || echo "not set")"
    else
        echo "  â””â”€ Setup required: Edit ${CONFIG_FILE}"
    fi

    echo ""

    # Obsidian status
    echo -e "${BLUE}ðŸ““ Obsidian:${NC}"
    local obs_path=$(jq -r '.obsidian.vault_path' "${CONFIG_FILE}" 2>/dev/null | sed "s|~|${HOME}|")
    if [[ -d "${obs_path}" ]]; then
        echo "  â”œâ”€ Vault: Found âœ“"
        echo "  â””â”€ Path: ${obs_path}"
    else
        echo "  â””â”€ Vault: Not found at ${obs_path}"
    fi

    echo ""

    # Session state
    if [[ -f "${SESSION_FILE}" ]]; then
        echo -e "${BLUE}ðŸ”§ Session:${NC}"
        local session_start=$(jq -r '.start_time // "unknown"' "${SESSION_FILE}" 2>/dev/null || echo "unknown")
        local session_todos=$(jq -r '.todowrite_count // 0' "${SESSION_FILE}" 2>/dev/null || echo "0")
        echo "  â”œâ”€ Started: ${session_start}"
        echo "  â””â”€ TodoWrite count: ${session_todos}"
    fi
}

# Sync command
cmd_sync() {
    log "Starting sync operations..."

    # Check if sync script exists
    if [[ -f "${SCRIPTS_DIR}/sync-tw-gcal.py" ]]; then
        log_info "Syncing Taskwarrior â†’ Google Calendar..."
        python3 "${SCRIPTS_DIR}/sync-tw-gcal.py" || log_warn "GCal sync failed"
    else
        log_warn "GCal sync script not found (will be created in Phase 5)"
    fi

    # Obsidian export
    if [[ -f "${SCRIPTS_DIR}/export-tw-obsidian.sh" ]]; then
        log_info "Exporting to Obsidian..."
        bash "${SCRIPTS_DIR}/export-tw-obsidian.sh" || log_warn "Obsidian export failed"
    else
        log_warn "Obsidian export script not found (will be created in Phase 8)"
    fi

    log "Sync complete âœ“"
}

# Import from TickTick
cmd_import() {
    log "Importing from TickTick..."

    if [[ ! -f "${SCRIPTS_DIR}/sync-ticktick-tw.py" ]]; then
        log_error "TickTick import script not found"
        log_info "Will be created in Phase 6"
        return 1
    fi

    python3 "${SCRIPTS_DIR}/sync-ticktick-tw.py" || {
        log_error "TickTick import failed"
        return 1
    }

    log "Import complete âœ“"
}

# Session management
cmd_session() {
    local action="${1:-start}"

    case "${action}" in
        start)
            log "Starting ClaudeWarrior session..."

            # Initialize session-logger if available
            if command -v session-logger &>/dev/null; then
                session-logger init
                log_info "Session logger initialized"
            fi

            # Create session state
            cat > "${SESSION_FILE}" << EOF
{
  "start_time": "$(date -Iseconds)",
  "todowrite_count": 0,
  "migrated_tasks": [],
  "active": true
}
EOF

            # Check for stale Taskwarrior tasks
            local stale_days=$(jq -r '.thresholds.stale_task_warn_days // 7' "${CONFIG_FILE}" 2>/dev/null || echo "7")
            local stale_count=$(task +claudewarrior status:pending modified.before:now-${stale_days}days count 2>/dev/null || echo "0")

            if [[ "${stale_count}" -gt 0 ]]; then
                log_warn "Found ${stale_count} stale tasks (no activity in ${stale_days}+ days)"
                log_info "Run: task +claudewarrior and status:pending and modified.before:now-${stale_days}days"
            fi

            log "Session started âœ“"
            ;;

        end)
            log "Ending ClaudeWarrior session..."

            if [[ ! -f "${SESSION_FILE}" ]]; then
                log_warn "No active session found"
                return 0
            fi

            # Show session summary
            local start_time=$(jq -r '.start_time // "unknown"' "${SESSION_FILE}" 2>/dev/null)
            local migrated=$(jq -r '.migrated_tasks | length' "${SESSION_FILE}" 2>/dev/null || echo "0")

            # Calculate duration for display and logging
            local duration_minutes=$(( ($(date +%s) - $(date -d "${start_time}" +%s 2>/dev/null || echo "0")) / 60 ))

            echo ""
            log "Session Summary:"
            echo "  â”œâ”€ Started: ${start_time}"
            echo "  â”œâ”€ Duration: ${duration_minutes} minutes"
            echo "  â””â”€ Tasks migrated: ${migrated}"
            echo ""

            # Log to session-logger if available
            if command -v session-logger &>/dev/null; then
                local summary="Duration: ${duration_minutes}min, Tasks migrated: ${migrated}"
                session-logger log "Session End" "${summary}"
                log_info "Logged to session-logger"
            fi

            # Send Telegram notification if configured
            local tele_script="${HOME}/.dotfiles/scripts/utils/telegram/tele.sh"
            if [[ -f "${tele_script}" ]] && [[ -f "${HOME}/.config/telegram.env" ]]; then
                # Parse session events from session-logger
                local session_events=""
                local session_log="${HOME}/AlphaOs-Vault/SESSION_LOGS/.current_session.md"

                if [[ -f "${session_log}" ]]; then
                    # Extract last 5 events (excluding Session End which we're adding now)
                    session_events=$(grep -A 1 "^###" "${session_log}" | \
                        grep -v "^--$" | \
                        grep -v "Session End" | \
                        tail -n 10 | \
                        awk '
                            /^###/ {
                                match($0, /\[([^\]]+)\] (.+)/, arr)
                                time = "[" arr[1] "]"
                                type = arr[2]
                                getline
                                if ($0 !~ /^###/ && $0 != "") {
                                    print "â€¢ " time " " type ": " $0
                                } else {
                                    print "â€¢ " time " " type
                                }
                            }
                        ' | head -n 5)
                fi

                local tele_message="âš”ï¸ *ClaudeWarrior Session Ended*

â±ï¸ Duration: ${duration_minutes}min
ðŸ“ Tasks migrated: ${migrated}
ðŸ• Ended: $(date +'%H:%M:%S')"

                # Add session activity if available
                if [[ -n "${session_events}" ]]; then
                    tele_message="${tele_message}

ðŸ“‹ Session Activity:
${session_events}"
                fi

                bash "${tele_script}" "${tele_message}" 2>/dev/null && \
                    log_info "Telegram notification sent" || \
                    log_warn "Telegram notification failed (check config)"
            fi

            # Archive session state
            local archive_file="${LOG_DIR}/session-$(date +%Y%m%d-%H%M%S).json"
            mv "${SESSION_FILE}" "${archive_file}"

            log "Session archived to ${archive_file}"
            ;;

        *)
            log_error "Unknown session action: ${action}"
            log_info "Usage: claudewarrior session [start|end]"
            return 1
            ;;
    esac
}

# Help text
cmd_help() {
    cat << 'EOF'
ClaudeWarrior - Intelligent Task Orchestration System

USAGE:
    claudewarrior <command> [options]

COMMANDS:
    status              Show current status of all integrations
    sync                Trigger manual sync (TWâ†’GCal, TWâ†’Obsidian)
    import              Import tasks from TickTick (tag: +claudewarrior)
    session start       Start a new Claude Code session
    session end         End session and show summary
    help                Show this help message

CONFIG:
    Config file: ~/.config/claudewarrior/config.json
    Logs: ~/.config/claudewarrior/logs/

EXAMPLES:
    claudewarrior status           # Check sync status
    claudewarrior sync             # Sync all integrations
    claudewarrior import           # Import from TickTick
    claudewarrior session start    # Initialize session

For more info, see: ~/.agents/prompts/claudewarrior.md
EOF
}

# Main dispatcher
main() {
    # Ensure config exists
    ensure_config

    # Parse command
    local command="${1:-help}"
    shift || true

    case "${command}" in
        status)
            cmd_status "$@"
            ;;
        sync)
            cmd_sync "$@"
            ;;
        import)
            cmd_import "$@"
            ;;
        session)
            cmd_session "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            log_error "Unknown command: ${command}"
            echo ""
            cmd_help
            exit 1
            ;;
    esac
}

# Run main
main "$@"
