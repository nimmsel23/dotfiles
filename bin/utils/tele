#!/usr/bin/env bash
# Telegram CLI - Send messages from terminal
# Usage: tele "your message"

set -euo pipefail

# Config location (in AlphaOs-Vault for backup)
CONF="$HOME/AlphaOs-Vault/.config/tele.env"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

init_config() {
    echo ""
    echo -e "${BLUE}ğŸ“± Telegram CLI Setup${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "You need:"
    echo "  1. Bot token from @BotFather"
    echo "  2. Your chat ID (send /start to bot, then check updates)"
    echo ""
    echo "Get chat ID: https://api.telegram.org/bot<TOKEN>/getUpdates"
    echo ""

    read -rp "BOT_TOKEN: " BOT_TOKEN
    read -rp "CHAT_ID: " CHAT_ID

    # Create directory if needed
    mkdir -p "$(dirname "$CONF")"

    # Save config
    cat > "$CONF" <<EOF
# Telegram Bot Configuration
BOT_TOKEN=$BOT_TOKEN
CHAT_ID=$CHAT_ID
EOF

    chmod 600 "$CONF"

    echo ""
    echo -e "${GREEN}âœ… Config saved to: $CONF${NC}"
    echo ""
}

# Check if config exists
if [[ ! -f $CONF ]]; then
    init_config
fi

# Load config
# shellcheck source=/dev/null
source "$CONF"

# Validate config
if [[ -z ${BOT_TOKEN:-} ]] || [[ -z ${CHAT_ID:-} ]]; then
    echo -e "${RED}âŒ Invalid config. Run setup again.${NC}"
    rm "$CONF"
    init_config
    source "$CONF"
fi

# Command handling
case "${1:-}" in
    --help|-h|help)
        echo "Telegram CLI - Send messages from terminal"
        echo ""
        echo "Usage:"
        echo "  tele \"message\"           Send message"
        echo "  tele -s \"message\"        Send silently (no notification)"
        echo "  tele --status             Check bot status"
        echo "  tele --setup              Reconfigure bot"
        echo ""
        exit 0
        ;;

    --setup|setup)
        echo "Reconfiguring..."
        rm "$CONF"
        init_config
        exit 0
        ;;

    --status|status)
        echo -e "${BLUE}Checking bot status...${NC}"
        RESPONSE=$(curl -sS "https://api.telegram.org/bot${BOT_TOKEN}/getMe")
        if echo "$RESPONSE" | grep -q '"ok":true'; then
            BOT_NAME=$(echo "$RESPONSE" | grep -o '"username":"[^"]*"' | cut -d'"' -f4)
            echo -e "${GREEN}âœ… Bot is online: @$BOT_NAME${NC}"
        else
            echo -e "${RED}âŒ Bot check failed${NC}"
            echo "$RESPONSE"
        fi
        exit 0
        ;;

    -s|--silent)
        shift
        SILENT=true
        ;;

    "")
        echo -e "${YELLOW}Usage: tele \"message\"${NC}"
        exit 1
        ;;
esac

# Get message
MESSAGE="$*"

# Send message
SEND_OPTS="-sS -X POST"
URL="https://api.telegram.org/bot${BOT_TOKEN}/sendMessage"
DATA="chat_id=${CHAT_ID}&text=${MESSAGE}"

if [[ ${SILENT:-false} == true ]]; then
    DATA="${DATA}&disable_notification=true"
fi

RESPONSE=$(curl $SEND_OPTS "$URL" -d "$DATA")

if echo "$RESPONSE" | grep -q '"ok":true'; then
    if [[ ${SILENT:-false} == true ]]; then
        echo -e "${GREEN}ğŸ“¨ Message sent (silent)${NC}"
    else
        echo -e "${GREEN}ğŸ“¨ Message sent${NC}"
    fi
else
    echo -e "${RED}âŒ Send failed${NC}"
    echo "$RESPONSE"
    exit 1
fi
