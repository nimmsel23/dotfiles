#!/usr/bin/env bash
#
# Telegram CLI: tele message goes here (no quotes needed!)
# Config: ~/AlphaOs-Vault/.config/tele.env
#

set -euo pipefail
CONF="$HOME/AlphaOs-Vault/.config/tele.env"

init_config() {
  printf "\nğŸŒ  Telegram Setup\n"
  read -rp "BOT_TOKEN = " BOT_TOKEN
  read -rp "CHAT_ID   = " CHAT_ID
  mkdir -p "$(dirname "$CONF")"
  printf 'BOT_TOKEN=%s\nCHAT_ID=%s\n' "$BOT_TOKEN" "$CHAT_ID" > "$CONF"
  chmod 600 "$CONF"
  echo "âœ…  Config saved â†’ $CONF"
}

# Handle special commands BEFORE loading config
case "${1:-}" in
  --setup)
    rm -f "$CONF"
    init_config
    exit 0
    ;;
  --help|-h)
    echo "Telegram CLI - Send messages from terminal"
    echo ""
    echo "Usage:"
    echo "  tele hello world           Send message (no quotes needed)"
    echo "  tele -s quiet message      Send silently"
    echo "  tele --status              Check bot status"
    echo "  tele --setup               Configure bot"
    exit 0
    ;;
esac

# Load config
[[ -f $CONF ]] || init_config
source "$CONF"

# No arguments? Show usage
[[ $# -gt 0 ]] || { echo "Usage: tele your message here"; exit 1; }

# Parse optional flags
SILENT=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -s|--silent)
      SILENT="&disable_notification=true"
      shift
      ;;
    --status)
      echo "Checking bot status..."
      curl -sS "https://api.telegram.org/bot${BOT_TOKEN}/getMe" | grep -q '"ok":true' \
        && echo "âœ… Bot online" \
        || echo "âŒ Bot offline"
      exit 0
      ;;
    *)
      break
      ;;
  esac
done

# Get message (all remaining args)
TEXT="$*"
[[ -n $TEXT ]] || { echo "Error: No message"; exit 1; }

# Send
curl -sS -X POST \
  "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
  -d "chat_id=${CHAT_ID}" \
  -d "text=${TEXT}${SILENT}" \
  >/dev/null && echo "ğŸ“¨ Sent"
