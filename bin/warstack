#!/usr/bin/env bash
# warstack - War Stack management CLI
#
# Usage:
#   warstack new <domain>           # Create new War Stack from template
#   warstack to-fire <file> [kw]    # Generate Fire Map from War Stack
#   warstack list                   # List all War Stacks
#   warstack status                 # Show War Stack status

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[âœ“]${NC} $1"; }
log_error() { echo -e "${RED}[âœ—]${NC} $1"; }

# Paths
WAR_STACK_DIR="/home/alpha/Dokumente/AlphaOs-Vault/DOOR/War-Stacks"
TEMPLATE="/home/alpha/Dokumente/AlphaOs-Vault/GAME/Templates/WAR_STACK_Template.md"
GENERATOR="/home/alpha/.dotfiles/scripts/utils/warstack-to-firemap.sh"

show_help() {
    cat << EOF
warstack - War Stack Management CLI

USAGE:
    warstack <command> [options]

COMMANDS:
    new <domain>           Create new War Stack from template
                          Domain: BODY, BEING, BALANCE, BUSINESS

    to-fire <file> [kw]   Generate Fire Map from War Stack
                          file: War Stack filename or path
                          kw: Week number (default: current)

    list                  List all War Stacks

    status                Show War Stack status

    help                  Show this help

EXAMPLES:
    # Create new War Stack for BUSINESS domain
    warstack new BUSINESS

    # Generate Fire Map from War Stack
    warstack to-fire WAR_STACK_Modul_X.md

    # Generate for specific week
    warstack to-fire WAR_STACK_Modul_X.md 50

    # List all War Stacks
    warstack list

EOF
}

cmd_new() {
    local DOMAIN="${1:-}"

    if [[ -z "$DOMAIN" ]]; then
        log_error "Domain required: BODY, BEING, BALANCE, BUSINESS"
        exit 1
    fi

    # Validate domain
    case "$DOMAIN" in
        BODY|BEING|BALANCE|BUSINESS) ;;
        *)
            log_error "Invalid domain: $DOMAIN"
            log_info "Valid: BODY, BEING, BALANCE, BUSINESS"
            exit 1
            ;;
    esac

    # Prompt for Door name
    read -p "Door name (e.g., 'Modul X abschlieÃŸen'): " DOOR_NAME

    if [[ -z "$DOOR_NAME" ]]; then
        log_error "Door name required"
        exit 1
    fi

    # Sanitize filename
    FILENAME="WAR_STACK_$(echo "$DOOR_NAME" | sed 's/ /_/g' | sed 's/[^a-zA-Z0-9_-]//g').md"
    OUTPUT="$WAR_STACK_DIR/$FILENAME"

    # Create War-Stacks dir if needed
    mkdir -p "$WAR_STACK_DIR"

    # Copy template
    cp "$TEMPLATE" "$OUTPUT"

    log_success "War Stack created: $OUTPUT"
    log_info "Next: Edit file and fill in Door details"
    log_info "Then: warstack to-fire $(basename "$OUTPUT")"
}

cmd_to_fire() {
    local FILE="${1:-}"
    local KW="${2:-$(date +%V)}"

    if [[ -z "$FILE" ]]; then
        log_error "War Stack file required"
        exit 1
    fi

    # If not a path, look in War-Stacks dir
    if [[ ! -f "$FILE" ]]; then
        FILE="$WAR_STACK_DIR/$FILE"
    fi

    if [[ ! -f "$FILE" ]]; then
        log_error "War Stack not found: $FILE"
        exit 1
    fi

    log_info "Generating Fire Map from: $(basename "$FILE")"
    "$GENERATOR" "$FILE" "$KW"
}

cmd_list() {
    log_info "War Stacks:"
    echo ""

    if [[ ! -d "$WAR_STACK_DIR" ]]; then
        log_error "War Stacks directory not found: $WAR_STACK_DIR"
        exit 1
    fi

    local STACKS=($(ls -t "$WAR_STACK_DIR"/WAR_STACK_*.md 2>/dev/null))

    if [[ ${#STACKS[@]} -eq 0 ]]; then
        log_error "No War Stacks found"
        log_info "Create one: warstack new BODY"
        exit 0
    fi

    for stack in "${STACKS[@]}"; do
        local FILENAME=$(basename "$stack")
        local DOOR=$(grep -A1 "## ðŸšª THE DOMINO DOOR" "$stack" | tail -1 | sed 's/\[//g' | sed 's/\]//g' | xargs || echo "No door name")
        echo "  â€¢ $FILENAME"
        echo "    Door: $DOOR"
        echo ""
    done
}

cmd_status() {
    log_info "War Stack Status"
    echo ""

    if [[ ! -d "$WAR_STACK_DIR" ]]; then
        log_error "War Stacks directory not found"
        exit 1
    fi

    local STACKS=($(ls -t "$WAR_STACK_DIR"/WAR_STACK_*.md 2>/dev/null))

    if [[ ${#STACKS[@]} -eq 0 ]]; then
        log_error "No War Stacks found"
        exit 0
    fi

    for stack in "${STACKS[@]}"; do
        local FILENAME=$(basename "$stack")
        local DOMAIN="UNKNOWN"

        if grep -q "ðŸ”´ BODY" "$stack"; then
            DOMAIN="BODY"
        elif grep -q "ðŸ”µ BEING" "$stack"; then
            DOMAIN="BEING"
        elif grep -q "ðŸŸ¡ BALANCE" "$stack"; then
            DOMAIN="BALANCE"
        elif grep -q "ðŸŸ¢ BUSINESS" "$stack"; then
            DOMAIN="BUSINESS"
        fi

        echo "  â€¢ $FILENAME ($DOMAIN)"
    done
}

# Main
case "${1:-help}" in
    new)
        shift
        cmd_new "$@"
        ;;
    to-fire)
        shift
        cmd_to_fire "$@"
        ;;
    list)
        cmd_list
        ;;
    status)
        cmd_status
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
